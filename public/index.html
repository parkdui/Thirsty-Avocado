<!doctype html>
<html>
  <head>
    <title>목마른 아보카도: 모바일</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <style>
      @font-face {
        font-family: "Galmuri11Condensed";
        src: url("https://cdn.jsdelivr.net/gh/projectnoonnu/2506-1@1.0/Galmuri11-Condensed.woff2")
          format("woff2");
        font-weight: normal;
        font-display: swap;
      }
      html {
        height: 100%;
      }
      body {
        font-family: "Galmuri11Condensed", sans-serif;
        margin: 0;
        background-color: #1a1a1a;
        color: #f3ffc7;
        overflow: hidden;
      }

      #canvas3d {
        position: fixed; /* 배경이 스크롤되지 않도록 고정 */
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1;
      }

      /* [변경] 컨테이너가 absolute 위치의 기준점이 되도록 설정 */
      .container {
        position: relative;
        z-index: 2;
        width: 100%;
        height: 100vh; /* 뷰포트 높이 100%를 차지하도록 명시 */
        box-sizing: border-box;
      }
      .fade-in {
        animation: fadeIn 1s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* [변경] 상단 컨텐츠를 화면 중앙에 절대적으로 배치 */
      #top-content {
        position: absolute;
        top: 45%;
        left: 50%;
        transform: translate(-50%, -50%); /* 정확한 중앙 정렬 */
        width: 90%;
        max-width: 400px;
        padding: 20px;
        box-sizing: border-box;
      }

      #logo-display,
      #question-area {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }

      #logo-display img {
        max-width: 100%;
        max-height: 70vh;
        object-fit: contain;
        filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.5));
      }

      #question-text {
        font-size: 1.8rem;
        line-height: 1.4;
        text-align: left;
        word-break: keep-all;
        width: 100%;
        /* text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); */
        white-space: pre-line;
      }

      .text-input {
        display: none; /* 평소에는 숨김 */
        background-color: rgba(0, 0, 0, 0.2);
        color: #f3ffc7;
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 12px;
        padding: 15px;
        font-size: 1.2rem;
        font-family: inherit;
        text-align: center;
        margin-top: 1.5rem;
        width: 100%;
        box-sizing: border-box;
      }
      .text-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }
      .text-input:focus {
        outline: 1px solid rgba(255, 255, 255, 0.6);
      }
      /* 메시지 입력창은 여러 줄 입력이 가능하도록 높이 조절 */
      #message-input {
        height: 100px;
        text-align: left;
      }

      /* [유지] 버튼 영역을 화면 하단에 절대적으로 고정하는 방식 */
      #choice-area {
        position: absolute;
        bottom: 12vh;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 400px;
        box-sizing: border-box;
      }
      #choice-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      .choice-button {
        background-color: rgba(255, 255, 255, 0.2);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 50px;
        padding: 20px;
        font-size: 1.2rem;
        cursor: pointer;
        transition:
          background-color 0.2s,
          transform 0.2s;
        font-family: inherit;
        font-weight: bold;
        backdrop-filter: blur(5px);
      }
      .choice-button:hover {
        background-color: rgba(255, 255, 255, 0.3);
      }
      .choice-button:active {
        transform: scale(0.98);
      }

      #message-container p {
        font-size: 1.8rem;
        line-height: 1.4;
        text-align: left;
        width: 90%;
        max-width: 400px;
        white-space: pre-line; /* 줄바꿈 문자(\n)를 인식합니다. */
      }
    </style>
  </head>
  <body>
    <canvas id="canvas3d"></canvas>

    <div class="container fade-in">
      <div id="top-content">
        <div id="logo-display">
          <img src="Logo Type.svg" alt="Thirsty Avocado Logo" />
        </div>
        <div id="question-area" style="display: none">
          <h1 id="question-text"></h1>
          <input
            type="text"
            id="name-input"
            class="text-input"
            placeholder="이름을 입력하세요..."
          />
          <!-- [추가] 메시지 입력창 HTML -->
          <textarea
            id="message-input"
            class="text-input"
            placeholder="아보카도에게 할 말을 적어주세요..."
          ></textarea>
        </div>
      </div>

      <div id="message-container"></div>

      <div id="choice-area">
        <div id="choice-container"></div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script
      async
      src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"
    ></script>
    <script type="importmap">
      {
        "imports": {
          "@splinetool/runtime": "https://unpkg.com/@splinetool/runtime@1.10.77/build/runtime.js"
        }
      }
    </script>
    <script type="module">
      import { Application } from "@splinetool/runtime";
      const canvas = document.getElementById("canvas3d");
      const app = new Application(canvas);
      app.load("https://prod.spline.design/x7tijJe3V0-ecl0S/scene.splinecode");
    </script>
    <script>
      const socket = io();
      const topContent = document.getElementById("top-content");
      const logoDisplay = document.getElementById("logo-display");
      const questionArea = document.getElementById("question-area");
      const questionTextElement = document.getElementById("question-text");
      const nameInput = document.getElementById("name-input");
      const messageInput = document.getElementById("message-input"); // [추가] 메시지 입력창 요소
      const choiceArea = document.getElementById("choice-area");
      const choiceContainer = document.getElementById("choice-container");
      const messageContainer = document.getElementById("message-container");
      let userName = "";
      let userMessage = ""; // [추가] 사용자 메시지 저장 변수

      const story = [
        { logo: true, choices: [{ text: "시작하기", next: 1 }] },
        {
          question: "안녕하세요.\n목이 마른 아보카도를 찾아오셨군요.",
          choices: [{ text: "네, 안녕하세요.", next: 2 }],
        },
        {
          question: "물을 주러 온 친절한 당신을, 뭐라고 부르면 될까요?",
          input: "name",
          choices: [{ text: "이렇게 불러주세요.", next: 3 }],
        },
        {
          question:
            "잘 알겠습니다, 반가워요, {name}.\n아보카도만큼이나 멋진 이름이네요.",
          choices: [
            { text: "그렇죠?", next: 4 },
            { text: "하하.", next: 4 },
          ],
        },
        {
          question: "......눈 앞에 놓인 두 개의 아보카도가 보입니까?",
          choices: [
            { text: "두 개요? 하나 아닌가요?", next: 5 },
            { text: "네, 보입니다.", next: 5 },
          ],
        },
        {
          question: "...정말 그렇게 생각하십니까?",
          choices: [
            { text: "네.", next: 6 },
            { text: "네.", next: 6 },
          ],
        },
        {
          question:
            "사실 여기 놓인 두 개의 아보카도들은 모두 당신을 빤히 바라보고 있습니다. 어때요, 시선이 느껴집니까?",
          choices: [
            { text: "네.", next: 7 },
            { text: "글쎄요.", next: 7 },
          ],
        },
        {
          question:
            "자세히 좀 보세요, 모두 물을 달라며 말라 비틀어지고 있잖습니까.",
          choices: [
            { text: "뭘 어떻게 하면 좋죠?", next: 8 },
            { text: "잘 모르겠는데요.", next: 8 },
          ],
        },
        {
          question:
            "방법은 간단합니다, 말을 주면 됩니다. 그러나 주의할 점이 있습니다.",
          choices: [{ text: "그게 뭐죠?", next: 9 }],
        },
        {
          question:
            "당신의 말은 한 쪽의 아보카도에게만 주어질 것입니다. 그럼 다른 한 쪽은 말을 마실 수 없죠.",
          choices: [{ text: "두 아보카도의 차이가 뭐죠?", next: 10 }],
        },
        {
          question:
            "좋은 질문입니다. 왼쪽 아보카도의 보이지 않는 뿌리는 미국 어딘가에 닿아있습니다. \n당신의 말 한 마디면, 미국 땅 어딘가에서 생수 한 모금이 추출되고, 이 아보카도의 갈증을 해소할 수 있을 겁니다.",
          choices: [{ text: "그렇군요.", next: 11 }],
        },
        {
          question:
            "부드러운 텍스쳐, 아니, 텍스트가 답변으로 돌아오는 건 덤이랍니다. 그 어떤 질문에도 답해줄 겁니다.",
          choices: [{ text: "그럼 다른 아보카도는?", next: 12 }],
        },
        {
          question:
            "오른쪽 아보카도는 믿거나 말거나, 진짜 아보카도입니다. 당신의 말 한 마디는 진짜 물이 되어서, 이 아보카도를 적셔줄 겁니다.",
          choices: [{ text: "그렇군요.", next: 13 }],
        },
        {
          question:
            "이 아보카도는 조용할 겁니다. 언젠가...그렇게 말들이 모이면 부드럽고 풍미 가득한 고소한 아보카도가 되겠지요.",
          choices: [
            { text: "...뭘 선택해야 하죠?", next: 14 },
            { text: "어느 아보카도가 더 낫죠?", next: 14 },
          ],
        },
        {
          question:
            "어느 쪽도 나쁘거나 좋거나, 도덕적이거나 비도덕적이진 않습니다. \n부드러운 답변을 원하든, 부드러운 과육을 원하든.",
          choices: [{ text: "...", next: 15 }],
        },
        {
          question:
            "중요한 건, 당신의 말과 터치는 한 번뿐이라는 겁니다. 선택은 돌이킬 수 없습니다. \n한 쪽을 선택하면, 선택받지 못한 다른 한 쪽은 말라갈 수밖에 없습니다.",
          choices: [{ text: "...", next: 16 }],
        },
        {
          question: "자, 그럼 아보카도에게 어떤 말을 줄지, 신중히 작성하시죠.",
          input: "message",
          choices: [{ text: "다 적었어요.", next: 17 }],
        },
        {
          question:
            "흠, 잘 알겠습니다. 그 말 그대로 전해주죠. \n그럼... 그 말을 어느 쪽 아보카도에게 주시겠습니까?",
          choices: [
            { text: "왼쪽, 가상의 아보카도", action: "ask" },
            { text: "오른쪽, 현실의 아보카도", action: "pump" },
          ],
        },
      ];
      let currentStoryIndex = 0;

      function renderStory(index) {
        const current = story[index];

        choiceContainer.innerHTML = "";
        choiceContainer.classList.remove("visible");
        messageContainer.innerHTML = "";

        if (current.logo) {
          logoDisplay.style.display = "flex";
          questionArea.style.display = "none";
          showChoices();
        } else {
          logoDisplay.style.display = "none";
          questionArea.style.display = "flex";

          let questionToDisplay = current.question.replace(
            "{name}",
            userName || "당신",
          );
          questionTextElement.textContent = "";

          let i = 0;
          const speed = 30;
          function typeWriter() {
            if (i < questionToDisplay.length) {
              questionTextElement.textContent += questionToDisplay.charAt(i);
              i++;
              setTimeout(typeWriter, speed);
            } else {
              // [수정] 어떤 입력창을 보여줄지 결정
              nameInput.style.display =
                current.input === "name" ? "block" : "none";
              messageInput.style.display =
                current.input === "message" ? "block" : "none";
              showChoices();
            }
          }
          typeWriter();
        }
      }

      function showChoices() {
        const current = story[currentStoryIndex];
        current.choices.forEach((choice) => {
          const button = document.createElement("button");
          button.textContent = choice.text;
          button.classList.add("choice-button");
          button.onclick = () => handleChoice(choice);
          choiceContainer.appendChild(button);
        });
        choiceContainer.classList.add("visible");
      }

      function handleChoice(choice) {
        const current = story[currentStoryIndex];

        if (current.input === "name") {
          userName = nameInput.value.trim() || "친절한 분";
        } else if (current.input === "message") {
          userMessage = messageInput.value.trim() || "안녕.";
        }

        if (choice.next !== undefined) {
          currentStoryIndex = choice.next;
          renderStory(currentStoryIndex);
        } else if (choice.action === "ask") {
          socket.emit("ask-question", userMessage);
          showCompletionMessage(
            "가상의 아보카도에게 말이 전달됩니다...\n태블릿을 확인하세요. 부드러운 텍스트는 덤.",
          );
        } else if (choice.action === "pump") {
          socket.emit("pump-water");
          showCompletionMessage(
            "현실의 아보카도에게 말을 주기로 결정했습니다...대답은 돌아오지 않지만, 언젠가 부드러운 과육이 올 것입니다.\n유리병을 확인하세요.",
          );
        }
      }

      function showCompletionMessage(text) {
        topContent.style.display = "none";
        choiceArea.style.display = "none";
        messageContainer.style.display = "flex";
        messageContainer.style.position = "absolute";
        // ... (나머지 스타일 동일)
        messageContainer.style.top = "0";
        messageContainer.style.left = "0";
        messageContainer.style.width = "100%";
        messageContainer.style.height = "100%";
        messageContainer.style.justifyContent = "center";
        messageContainer.style.alignItems = "center";
        const p = document.createElement("p");
        p.textContent = text;
        messageContainer.appendChild(p);
      }
      renderStory(currentStoryIndex);
    </script>
  </body>
</html>
